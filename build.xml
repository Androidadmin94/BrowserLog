
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0">

  <!-- Application Configurations -->
  <PropertyGroup>
    
    <NUnit-ToolPath>packages\NUnit.Runners.2.6.4\tools\</NUnit-ToolPath>
    <OpenCover-ToolPath>packages\OpenCover.4.6.166\tools\</OpenCover-ToolPath>
    <ReportGenerator-ToolPath>packages\ReportGenerator.2.3.2.0\tools\</ReportGenerator-ToolPath>
    
    <SolutionFile>BrowserLog.sln</SolutionFile>
    <OpenCover-AssemblyFilter>+[BrowserLog]*</OpenCover-AssemblyFilter>
    <SonarKey>BrowserLog</SonarKey>
    <SonarName>BrowserLog</SonarName>
    <SonarVersion>1.0.0.0-Latest</SonarVersion>
  </PropertyGroup>

  <UsingTask TaskName="ReportGenerator" AssemblyFile="$(ReportGenerator-ToolPath)\ReportGenerator.exe" />  

  <ItemGroup>
    <AllProjects Include="$(MSBuildProjectDirectory)\*.csproj" />
    <TestAssemblies Include="$(MSBuildProjectDirectory)\*\bin\debug\*.Tests.dll" />
    <CoverageFiles Include="*.coverage.xml" />
    <SourceDirectories Include="$(MSBuildProjectDirectory)" />
  </ItemGroup>
<!--
  <Target Name="Clean">
    <MSBuild Projects="@(AllProjects)" Targets="Clean" />
  </Target>

  <Target Name="Compile">
    <MSBuild Projects="@(AllProjects)" Targets="Build" Properties="WarningLevel=1" />
  </Target>
-->

  <Target Name="Clean">
    <MSBuild Projects="$(SolutionFile)" Targets="Clean" />
  </Target>

  <Target Name="Compile">
    <MSBuild Projects="$(SolutionFile)" Targets="Build" Properties="WarningLevel=1" />
  </Target>

  <Target Name="Test" DependsOnTargets="Clean;Compile">
    <Exec Command="$(NUnit-ToolPath)nunit-console-x86.exe @(TestAssemblies) /nologo /noshadow /domain=single /output=test-results.xml" />
  </Target>

  <Target Name="Build" DependsOnTargets="Clean;Compile;Test;" />

  <Target Name="Coverage" DependsOnTargets="Clean;Compile">
    <Delete Files="*.coverage.xml" />
    <Delete Files="TestResult.xml" />
    
    <!-- /domain=single is not support by the NUnit msbuild task, and it is required for OpenCover coverage test -->
    <Exec Command="$(OpenCover-ToolPath)OpenCover.Console.exe -register:user -target:&quot;$(NUnit-ToolPath)nunit-console-x86.exe&quot; -targetargs:&quot;/noshadow %(TestAssemblies.Identity) /domain:single&quot; -filter:&quot;$(OpenCover-AssemblyFilter)&quot; -output:%(TestAssemblies.FileName).coverage.xml" />
    
  </Target>

  <Target Name="CoverageReport" DependsOnTargets="Coverage">
    <ReportGenerator ReportFiles="@(CoverageFiles)" TargetDirectory="report" ReportTypes="Html" SourceDirectories="@(SourceDirectories)" HistoryDirectory="history"  />
  </Target>

  <Target Name="SonarEnd">
    <Exec Command="MSBuild.SonarQube.Runner.exe end" />
  </Target>

  <Target Name="Sonar">
    <PropertyGroup>
         <ReportPaths>@(TestAssemblies -> '$(MSBuildProjectDirectory)\%(filename).coverage.xml',',')</ReportPaths>
    </PropertyGroup>

    <Exec Command="MSBuild.SonarQube.Runner.exe begin /k:&quot;$(SonarKey)&quot; /n:&quot;$(SonarName)&quot; /v:&quot;$(SonarVersion)&quot; /d:sonar.cs.opencover.reportsPaths=&quot;$(ReportPaths)&quot;" />
  
    <CallTarget Targets="Coverage"/>

    <CallTarget Targets="SonarEnd"/>
  </Target>

  

</Project>